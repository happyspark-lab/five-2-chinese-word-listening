<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å¹´çº§ä¸‹å†Œ Â· è¯è¯­é—¯å…³ (iOSä¿®å¤ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary: #f97316; 
            --primary-dark: #c2410c;
            --bg-gradient: linear-gradient(135deg, #fff7ed 0%, #fff1f2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #431407;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; 
            padding: 15px;
        }

        .container {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(234, 88, 12, 0.15);
            width: 100%;
            max-width: 600px; /* æ‰‹æœºç«¯ç¨å¾®çª„ä¸€ç‚¹ */
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            position: relative;
        }

        header { text-align: center; margin-bottom: 5px; }
        .header-badge {
            background: #ffedd5; color: var(--primary-dark); font-size: 0.85rem;
            padding: 4px 12px; border-radius: 20px; display: inline-block;
            margin-bottom: 8px; font-weight: bold; border: 1px solid #fdba74;
        }
        h1 { 
            color: var(--primary); font-size: 1.6rem; margin: 0; 
            text-shadow: 1px 1px 0px rgba(254, 215, 170, 0.5);
        }

        .motivation-box {
            background: linear-gradient(to right, #fff7ed, #f7fee7);
            border-left: 4px solid #84cc16;
            padding: 12px;
            border-radius: 8px;
            color: #3f6212;
            font-size: 0.95rem;
            text-align: center;
            font-weight: bold;
            min-height: 48px;
            display: flex; align-items: center; justify-content: center;
        }

        .setup-panel {
            border: 2px dashed #fdba74; border-radius: 16px; padding: 20px;
            background: #fff; transition: all 0.3s;
        }

        .lesson-select {
            width: 100%; padding: 12px; font-size: 1.05rem;
            border: 2px solid var(--primary); border-radius: 10px;
            background: white; font-weight: bold; outline: none;
            color: #c2410c; margin-bottom: 5px;
        }

        .settings-row {
            display: flex; gap: 8px; justify-content: space-between; margin: 15px 0;
        }
        .setting-group { 
            flex: 1; text-align: center; background: #f8fafc;
            padding: 8px 5px; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .setting-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 3px;}
        select { 
            width: 100%; border: none; background: transparent; 
            font-weight: bold; color: #334155; text-align: center; font-size: 0.95rem;
        }

        .main-btn {
            background: linear-gradient(to bottom right, #f97316, #ea580c);
            color: white; border: none; padding: 16px; border-radius: 50px;
            font-size: 1.3rem; font-weight: 800; width: 100%;
            box-shadow: 0 8px 20px rgba(234, 88, 12, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .main-btn:active { transform: scale(0.98); }

        /* Running UI */
        .running-ui { display: none; text-align: center; padding: 10px 0; }
        .level-badge {
            background: #3b82f6; color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 0.8rem; font-weight: bold;
            display: inline-block; margin-bottom: 10px;
        }

        .big-word-display {
            font-size: 3.5rem; font-weight: 800; color: var(--text);
            margin: 15px 0; min-height: 80px; font-family: "KaiTi", "æ¥·ä½“", serif;
        }

        .progress-container {
            height: 12px; background: #e2e8f0; border-radius: 10px;
            overflow: hidden; margin: 15px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #facc15, #f97316);
            width: 0%; transition: width 0.3s ease-out;
        }

        .control-btns { display: flex; justify-content: center; gap: 15px; margin-top: 25px;}
        .control-btn {
            padding: 10px 20px; border-radius: 10px; border: none;
            font-weight: bold; font-size: 0.95rem;
        }
        .btn-pause { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-stop { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        .answer-list {
            margin-top: 20px; text-align: left; background: #fff7ed;
            padding: 15px; border-radius: 12px; display: none; border: 2px solid #ffedd5;
        }
        .answer-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;
        }
        .answer-item {
            background: white; padding: 10px 2px; border-radius: 8px;
            text-align: center; font-size: 1rem; font-weight: bold;
            color: #c2410c; border-bottom: 2px solid #fdba74;
        }

        /* éšè—æ‰ä¸€äº›å¤æ‚åŠŸèƒ½è®©ç•Œé¢åœ¨æ‰‹æœºæ›´æ¸…çˆ½ï¼Œç‚¹å‡»å¯å±•å¼€ */
        .expand-toggle { text-align: center; color: #94a3b8; font-size: 0.8rem; margin-top: 15px; padding: 10px;}
        #customInputArea { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;}
        textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }

        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .ios-tip { font-size: 0.75rem; color: #ef4444; background: #fee2e2; padding: 8px; border-radius: 8px; margin-bottom: 10px; text-align: left; display: none;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-badge">â­ è¯­æ–‡æœŸæœ«å¤§é—¯å…³ â­</div>
        <h1>äº”å¹´çº§ä¸‹ Â· è¯è¯­æŒ‘æˆ˜</h1>
    </header>
    
    <div id="iosTip" class="ios-tip">
        ğŸ“± <b>iPhoneç”¨æˆ·è¯·æ³¨æ„ï¼š</b><br>
        1. è¯·ç¡®ä¿<b>å–æ¶ˆé™éŸ³æ¨¡å¼</b>ï¼ˆæ‹¨å¼€æ‰‹æœºä¾§è¾¹é™éŸ³é”®ï¼‰ã€‚<br>
        2. è¯·è°ƒå¤§<b>åª’ä½“éŸ³é‡</b>ã€‚
    </div>

    <div class="motivation-box" id="motivationBox">
        å‡†å¤‡å¥½äº†å—ï¼Ÿç§¯å°‘æˆå¤šï¼Œè¿›æ­¥å¯è§ï¼
    </div>

    <div id="setupArea" class="setup-panel">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#c2410c; font-size:0.9rem;">ğŸ—ºï¸ é€‰æ‹©æŒ‘æˆ˜å…³å¡ï¼š</label>
        <select id="lessonSelect" class="lesson-select" onchange="previewWords()"></select>
        <div id="wordPreview" style="font-size:0.8rem; color:#999; margin-bottom:15px; height:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>

        <div class="settings-row">
            <div class="setting-group">
                <label>ğŸ—£ï¸ è¯­é€Ÿ</label>
                <select id="speechRate">
                    <option value="1">æ­£å¸¸</option>
                    <option value="0.8">ç¨æ…¢</option>
                    <option value="0.6" selected>è¾ƒæ…¢</option>
                    <option value="0.5">å¾ˆæ…¢</option>
                </select>
            </div>
            <div class="setting-group">
                <label>ğŸ” é‡å¤</label>
                <select id="repeatCount">
                    <option value="1">1æ¬¡</option>
                    <option value="2" selected>2æ¬¡</option>
                    <option value="3">3æ¬¡</option>
                </select>
            </div>
            <div class="setting-group">
                <label>âœï¸ ä¹¦å†™</label>
                <select id="waitTime">
                    <option value="5">5ç§’</option>
                    <option value="8" selected>8ç§’</option>
                    <option value="12">12ç§’</option>
                </select>
            </div>
        </div>

        <button class="main-btn" onclick="initDictation()">
            <span>ğŸš€ å¼€å¯æŒ‘æˆ˜</span>
        </button>

        <div class="expand-toggle" onclick="toggleCustomArea()">+ è‡ªå®šä¹‰ / PDFè¯†åˆ«</div>
        <div id="customInputArea">
             <textarea id="customWordInput" placeholder="åœ¨æ­¤ç²˜è´´è¯è¯­..."></textarea>
             <input type="file" accept="application/pdf" onchange="handlePdfUpload(event)" style="margin-top:8px; width:100%">
             <div id="ocrStatus" style="font-size:0.8rem; color:green; margin-top:5px;"></div>
        </div>
    </div>

    <div id="runningArea" class="running-ui">
        <span class="level-badge" id="currentLevelName">å½“å‰å…³å¡</span>
        
        <div class="progress-container">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText" style="font-size:0.8rem; color:#888;">0 / 0</div>

        <div class="big-word-display" id="wordDisplay">Ready</div>
        <div style="color: #64748b; font-size: 0.9rem;" id="statusMsg">ç‚¹å‡»å¼€å§‹</div>

        <div class="control-btns">
            <button class="control-btn btn-pause" id="pauseBtn" onclick="togglePause()">æš‚åœ</button>
            <button class="control-btn btn-stop" onclick="stopDictation()">ç»“æŸ</button>
        </div>

        <div class="answer-list" id="answerList"></div>
    </div>
</div>

<script>
    // --- æ•°æ®åŒº ---
    const lessonGroups = [
        { name: "ç¬¬1-2è¯¾ï¼šå¤è¯—ä¸å›­å­", words: ["ç™½æ˜¼", "æ˜¼å¤œ", "è€•è€˜", "è€˜ç”°", "æ¡‘æ ‘", "æ¡‘å¶", "æ‹‚æ™“", "å®¶å–»æˆ·æ™“", "è´è¶", "è´è¶ç»“", "é£è¶", "ç²‰è¶", "å—¡å—¡å“", "å—¡åŠ¨", "æ¨±èŠ±", "æ¨±æ¡ƒ", "æ¦†æ ‘", "æ¦†é’±", "æŒºæ‹”", "æ‹”æ²³", "çè¯´", "çé—¹", "é“²é™¤", "é“é“²", "é”„è‰", "é”„å¤´", "æ”¶å‰²", "åˆ†å‰²", "å°¾å·´", "ç»“å°¾", "æ‰¿è®¤", "ç»§æ‰¿", "æ‹´ä½", "æ‹´é©¬", "æ°´ç“¢", "ç“¢æ³¼å¤§é›¨", "é—²é€›", "é€›è¡—", "èœ»èœ“", "èš‚èš±", "åœ†æ»šæ»š", "æ˜æ™ƒæ™ƒ", "éšæ„"] },
        { name: "ç¬¬5è¯¾ï¼šè‰èˆ¹å€Ÿç®­", words: ["å¦’å¿Œ", "å«‰å¦’", "å¿Œè®³", "é¡¾å¿Œ", "æ›¹æ“", "ç›‘ç£", "éƒ½ç£", "å§”æ‰˜", "å§”å©‰", "é²å›½", "ç²—é²", "é®æŒ¡", "é®æ©", "è¿Ÿç–‘", "ç–‘é—®", "å›°æƒ‘", "è¯±æƒ‘", "å±±å¯¨", "æ°´å¯¨", "æ“‚é¼“", "æ“‚å°", "å‘å–Š", "å”¢å‘", "æ’å˜´", "æ’ç§§", "ç…§åŠ", "é¢„è®¡", "ç´§æ€¥", "å†›ä»¤çŠ¶", "æ¢å¬", "ç§è‡ª", "å¸ƒç½®", "è°ƒåº¦", "ç¥æœºå¦™ç®—"] },
        { name: "ç¬¬6-9è¯¾ï¼šæ™¯é˜³å†ˆä¸å¤è¯—", words: ["å±±å†ˆ", "äº•å†ˆå±±", "é¥¥é¥¿", "é¥¥è’", "ç¢Ÿå­", "é£ç¢Ÿ", "å…¬æ–¤", "æ–¤æ–¤è®¡è¾ƒ", "ä¿ºä»¬", "æ¦œæ ·", "æ¦œæ–‡", "æ‹æ–", "æ‰‹æ–", "ç”³è¯·", "é‡ç”³", "å…¼èŒ", "è½¯ç¡¬å…¼æ–½", "åˆ‡å‹¿", "è¯·å‹¿", "æ‹–å»¶", "æ‹–æ‹‰", "ç†Ÿæ‚‰", "è·æ‚‰", "ä¸‹å ", "å è½", "èƒ¸è†›", "æªè†›", "æˆªæ–­", "æˆªæ­¢", "åŠå¤œä¸‰æ›´", "å¯»æ€", "è€»ç¬‘", "æ­¦è‰º", "ç¯±ç¬†", "æ¨Šç¯±", "ä»ç„¶", "ä»æ—§", "äº”å²³", "å²³é£", "æ‘©æ“¦", "æŒ‰æ‘©", "é—æ†¾", "é—ç•™", "ä¼ é€’", "å¿«é€’", "å·«å©†", "å·«æœ¯"] },
        { name: "ç¬¬10è¯¾ï¼šé’å±±å¤„å¤„åŸ‹å¿ éª¨", words: ["å½­å¾·æ€€", "æ‹Ÿå®š", "æ¨¡æ‹Ÿ", "è®¡è°‹", "å‚è°‹", "ç‘é›ª", "ç¥¥ç‘", "æŸå¤±", "æŸè€—", "é”»ç‚¼", "é”»é€ ", "ç£¨ç‚¼", "æç‚¼", "çœ·æ‹", "å®¶çœ·", "å¥”èµ´", "èµ´çº¦", "æå¥½", "æå®š", "ç‰¹æ®Š", "æ®Šè£", "å°Šé‡", "å°Šä¸¥", "ç­¾å", "ç­¾è®¢", "é©å‘½", "æ”¹é©", "æƒ…ä¸è‡ªç¦", "æ…°é—®", "ç¹å¿™", "ä¸‹æ„è¯†"] },
        { name: "ç¬¬11è¯¾ï¼šå†›ç¥", words: ["åº†ç¥", "å›½åº†", "è¯Šæ–­", "é—¨è¯Š", "è‚¥æ²ƒ", "æ²ƒåœŸ", "å¹´é¾„", "å·¥é¾„", "åœŸåŒª", "åŒªå¾’", "ç»·å¸¦", "ç´§ç»·", "å®¡æŸ¥", "å®¡è§†", "è¯å‰‚", "è°ƒå‘³å‰‚", "æ–½å·¥", "æ–½å±•", "å­å£°", "å¼•å­é«˜æ­Œ", "å´­æ–°", "å´­éœ²å¤´è§’", "ç”±è¡·", "è‹¦è¡·", "æ…ˆç¥¥", "ä»æ…ˆ", "å‰ç¥¥", "å®‰è¯¦", "è¯Šæ‰€", "ç†Ÿç»ƒ", "ä¸€é’ˆè§è¡€", "æ–½è¡Œ", "æ¸…é†’", "é¢¤æŠ–", "ä¸€å£°ä¸å­", "è‹ç™½", "è‚ƒç„¶èµ·æ•¬", "è£å¹¸"] },
        { name: "ç¬¬13è¯¾ï¼šäººç‰©æå†™ä¸€ç»„", words: ["æ‘”è·¤", "è·Œè·¤", "æ‚æŠ±", "æ‚ä½", "æ‰“ä»—", "ä¾ä»—", "é­ç­–", "é­ç‚®", "æ¬ºè´Ÿ", "æ¬ºéª—", "é˜»æŒ ", "æŒ å¤´", "æ‰³æ‰‹", "æ‰³åŠ¨", "æ‰‹è…•", "è…•åŠ›", "å‰ƒå¤´", "å‰ƒé¡»", "è…®å¸®", "ä¸¤è…®", "ä¼¤ç–¤", "ç»“ç–¤", "ç›‘è§†", "ç›‘ç‹±", "ä¾„å­", "ä¾„å¥³", "å–‰å’™", "å–‰èˆŒ", "æ‰‹ç–¾çœ¼å¿«", "è„šè…•å­", "æŒºè„±", "è‚¢ä½“", "æ ¼å±€", "å¨ä¸¥"] },
        { name: "ç¬¬14-15è¯¾ï¼šåˆ·å­æä¸çŸ›ç›¾", words: ["æ³¥æµ†", "è±†æµ†", "å¸ˆå‚…", "å¤ªå‚…", "åŒ…è¢±", "æ•…éšœ", "å±éšœ", "èŠéº»", "çµèŠ", "ç¥åœ£", "åœ£äºº", "çŠ¯é”™", "ä¾µçŠ¯", "éœ²é¦…", "è‚‰é¦…", "è½°ç‚¸", "è½°åŠ¨", "éš¾å ª", "ä¸å ªè®¾æƒ³", "è¯ˆéª—", "å…µä¸åŒè¯ˆ", "å‚»ç“œ", "è£…å‚»", "æé€ ", "ææ³¥äºº", "å‘æ€”", "æ€”ä½", "ç²‰åˆ·", "ç»æ´»", "æ´¾å¤´", "æ‰‹æ³•", "é¼“ç‚¹", "è¡”æ¥", "çŸ›ç›¾", "é•¿çŸ›", "åç›¾", "ç›¾ç‰Œ", "è£èª‰", "åèª‰", "å¾è¾ˆ", "æ”¯å¾"] },
        { name: "ç¬¬16-17è¯¾ï¼šèµ›é©¬ä¸è·³æ°´", words: ["è¾“èµ¢", "èµ¢å®¶", "æ‹³å¤´", "æ‹³å‡»", "æ“¦æ‹­", "ç­–ç•¥", "ç­–åˆ’", "æ¨è", "ä¸¾è", "èµè¯†", "è„šåŠ›", "èƒ¸æœ‰æˆç«¹", "æ‘©æ‹³æ“¦æŒ", "è·ƒè·ƒæ¬²è¯•", "å…´è‡´å‹ƒå‹ƒ", "å‡ºè°‹åˆ’ç­–", "å¼•è", "ä¸€è‰˜èˆ¹", "èˆªç©º", "èˆªè¡Œ", "æ”¾è‚†", "è‚†è™", "å¸½å­", "è‰å¸½", "æ¡…æ†", "æ’•ç ´", "æ’•è£‚", "é€—ç¬‘", "é€—ç•™", "å“å”¬", "å”¬äºº", "é±¼é’©", "æŒ‚é’©", "æ‰­æ‰“", "æ‰­ä¼¤", "å’§å˜´", "å¤§å¤§å’§å’§", "èˆ¹èˆ±", "æœºèˆ±", "æµ·é¸¥", "å–µå–µå«", "é£å¹³æµªé™", "å–ä¹", "å“­ç¬‘ä¸å¾—", "çœ¼å·´å·´", "ç„å‡†", "å¿ƒæƒŠèƒ†æˆ˜"] },
        { name: "ç¬¬18-19è¯¾ï¼šå¨å°¼æ–¯ä¸ç‰§åœº", words: ["å°¼å§‘", "å°¼é¾™", "æ–¯æ–‡", "ç“¦æ–¯", "æ¸¸è‰‡", "æ½œæ°´è‰‡", "çºµæ¨ª", "çºµèº«", "èˆ¹è‰„", "ç¿˜èµ·", "ç¿˜é¦–", "å«å­", "åºŠå«", "ä¿å§†", "ç¥·å‘Š", "ç¥ˆç¥·", "é›‡ä½£", "è§£é›‡", "ç°‡æ‹¥", "èŠ±å›¢é”¦ç°‡", "å“—ç„¶", "å–§å“—", "å·ç ", "ç å¤´", "æ“çºµ", "æ‰‹å¿™è„šä¹±", "æ²‰å¯‚", "åœæ³Š", "ç¬¼ç½©", "ç«¯åº„", "ä»ªæ€", "è¿œçœº", "çœºæœ›", "éªé©¬", "è‹±ä¿Š", "å¥”é©°", "æ¾å¼›", "è¾½é˜”", "è¾½è¿œ", "ç»µç¾Š", "ç»µå»¶", "æ¿å‡³", "å‡³å­", "å†å–", "é“ƒå£°", "é“ƒé“›", "ç½å¤´", "ç“¦ç½", "æ¢å¤", "å¤©ç½‘æ¢æ¢", "è¸¢çƒ", "è¸¢è¸", "ç‰ºç‰²", "ç•œç‰²", "ç‰²ç•œ", "å®¶ç•œ", "é®æ©", "é˜»æŒ¡", "é£é©°", "èµè®¸", "æ²‰ç¡", "ç¯å¡”"] },
        { name: "ç¬¬21-22è¯¾ï¼šæ¨æ°ä¸æ‰‹æŒ‡", words: ["æ ‹æ¢", "æ¡¥æ¢", "èªæ˜", "èªæ…§", "é€ è¯£", "è‹¦å¿ƒå­¤è¯£", "å®¶ç¦½", "é£ç¦½", "æ‹‡æŒ‡", "å¤§æ‹‡æŒ‡", "æ”ç—’", "æ”å¤´", "å‘ç—’", "æŒ ç—’ç—’", "æ±¡ç§½", "ç§½ç‰©", "è½§é’¢", "è½§è·¯æœº", "æ‹§å¼€", "æ‹§å¹²", "èºä¸", "æµ·èº", "çº½æ‰£", "æ¢çº½", "æ‰£å­", "æŠ˜æ‰£", "ç¤¼è²Œ", "ç›¸è²Œ", "ä»“åº“", "ä»“ä¿ƒ", "æ¸ºå°", "æ¸ºèŒ«", "äº«å—", "åˆ†äº«", "å¹³åº¸", "åº¸ä¿—", "æ†æ¨", "çˆ±æ†åˆ†æ˜", "æ¥è§¦", "å…»å°Šå¤„ä¼˜", "äº«ä¹", "é™„åº¸", "å›¢ç»“"] }
    ];

    const quotes = {
        start: ["ç§¯å°‘æˆå¤šï¼Œæ¯ä¸€æ­¥éƒ½ç®—æ•°ï¼", "æ·±å‘¼å¸ï¼Œç›¸ä¿¡è‡ªå·±ï¼", "ä¸“æ³¨æ˜¯ä½ æœ€å¼ºå¤§çš„æ­¦å™¨ã€‚", "ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜¯ä¸ºäº†æ˜å¤©æ›´æ£’çš„è‡ªå·±ï¼"],
        half: ["å¤ªæ£’äº†ï¼å·²ç»è¿‡åŠäº†ï¼", "åšæŒä½ï¼Œä½ å°±æ˜¯æœ€é“çš„ä»”ï¼", "åŠ æ²¹ï¼Œèƒœåˆ©å°±åœ¨å‰æ–¹ï¼"],
        end: ["æŒ‘æˆ˜æˆåŠŸï¼ä½ åˆè¿›æ­¥äº†ï¼", "å®Œç¾é€šå…³ï¼ç»™è‡ªå·±é¼“ä¸ªæŒï¼"]
    };

    // --- å…¨å±€å˜é‡ ---
    let currentSessionList = [];
    let currentIndex = 0;
    let isRunning = false;
    let isPaused = false;
    let synth = window.speechSynthesis;
    
    // ğŸ”¥ iOS å…³é”®ä¿®å¤ï¼šå®šä¹‰å…¨å±€ utterance å˜é‡ï¼Œé˜²æ­¢è¢«åƒåœ¾å›æ”¶
    let currentUtterance = null;
    let chineseVoice = null;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        initLessonSelector();
        updateMotivation(quotes.start[Math.floor(Math.random()*quotes.start.length)]);
        
        // æ£€æµ‹ iOS å¹¶æ˜¾ç¤ºæç¤º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            document.getElementById('iosTip').style.display = 'block';
        }

        // å°è¯•é¢„åŠ è½½è¯­éŸ³
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
    }

    function loadVoices() {
        const voices = synth.getVoices();
        // ä¼˜å…ˆæ‰¾ä¸­æ–‡è¯­éŸ³ï¼ŒiOSä¸Šé€šå¸¸å« "Ting-Ting" æˆ–è€…åŒ…å« "zh"
        chineseVoice = voices.find(v => v.lang === 'zh-CN' || v.lang === 'zh-HK' || v.name.includes('Ting'));
    }

    function initLessonSelector() {
        const select = document.getElementById('lessonSelect');
        select.innerHTML = '';
        lessonGroups.forEach((group, index) => {
            const option = document.createElement('option');
            option.value = index;
            const uniqueCount = new Set(group.words).size;
            option.text = `${group.name} [${uniqueCount}è¯]`;
            select.appendChild(option);
        });
        if(lessonGroups.length > 0) previewWords();
    }

    function previewWords() {
        const index = document.getElementById('lessonSelect').value;
        const words = lessonGroups[index].words;
        const uniqueWords = [...new Set(words)];
        document.getElementById('wordPreview').innerText = "é¢„è§ˆ: " + uniqueWords.join("ã€");
    }

    function toggleCustomArea() {
        const area = document.getElementById('customInputArea');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }

    function updateMotivation(text) {
        const box = document.getElementById('motivationBox');
        box.style.opacity = 0;
        setTimeout(() => { box.innerText = text; box.style.opacity = 1; }, 300);
    }

    // --- å¬å†™é€»è¾‘ ---

    function initDictation() {
        // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 1ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»ç¬é—´ï¼Œå¿…é¡»è§¦å‘ä¸€æ¬¡ synth.speak
        // å³ä½¿æ˜¯ç©ºå­—ç¬¦ï¼Œä¹Ÿèƒ½æ¿€æ´»éŸ³é¢‘å¼•æ“
        synth.cancel();
        const warmUp = new SpeechSynthesisUtterance('');
        synth.speak(warmUp);

        const customInput = document.getElementById('customWordInput').value.trim();
        let sessionName = "";

        if (customInput.length > 0) {
            currentSessionList = processTextToWords(customInput);
            if(currentSessionList.length === 0) { alert("æ— æ•ˆçš„è¯è¯­è¾“å…¥"); return; }
            sessionName = "è‡ªå®šä¹‰æŒ‘æˆ˜";
        } else {
            const index = document.getElementById('lessonSelect').value;
            currentSessionList = [...new Set(lessonGroups[index].words)];
            sessionName = lessonGroups[index].name;
        }

        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('runningArea').style.display = 'block';
        document.getElementById('answerList').style.display = 'none';
        document.getElementById('answerList').innerHTML = '';
        document.getElementById('currentLevelName').innerText = sessionName;

        startSession();
    }

    function processTextToWords(text) {
        const extracted = text.match(/[\u4e00-\u9fa5]+/g);
        if (!extracted) return [];
        return [...new Set(extracted.filter(w => w.length >= 1))];
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    async function startSession() {
        isRunning = true;
        isPaused = false;
        currentIndex = 0;
        document.getElementById('pauseBtn').innerText = 'æš‚åœ';
        
        const display = document.getElementById('wordDisplay');
        const status = document.getElementById('statusMsg');
        
        // å€’è®¡æ—¶
        status.innerText = "å‡†å¤‡å¼€å§‹...";
        for(let i=3; i>0; i--) {
            display.innerText = i;
            await sleep(1000);
        }

        const total = currentSessionList.length;

        while (currentIndex < total && isRunning) {
            updateProgress();
            
            if (currentIndex === Math.floor(total / 2)) {
                updateMotivation(quotes.half[Math.floor(Math.random()*quotes.half.length)]);
            }

            await checkPause();
            if (!isRunning) break;

            const word = currentSessionList[currentIndex];
            
            display.style.animation = 'none';
            display.offsetHeight; 
            display.style.animation = 'popIn 0.5s';
            
            display.innerText = `ç¬¬ ${currentIndex + 1} ä¸ª`;
            display.style.color = '#431407';
            status.innerText = 'æ­£åœ¨æœ—è¯»...';

            const repeat = parseInt(document.getElementById('repeatCount').value);
            for (let r=0; r < repeat; r++) {
                await checkPause(); 
                if (!isRunning) break;
                
                await speakWord(word); // ç­‰å¾…æœ—è¯»å®Œæˆ
                
                if (r < repeat - 1) await sleep(1200); 
            }

            if (!isRunning) break;
            status.innerText = 'è¯·ä¹¦å†™...';
            display.style.color = '#e2e8f0'; 
            
            const waitTime = parseInt(document.getElementById('waitTime').value) * 10; 
            for(let t=0; t<waitTime; t++) { 
                await checkPause();
                if (!isRunning) break;
                await sleep(100);
            }

            currentIndex++;
        }

        if (isRunning) {
            finishDictation();
        }
    }

    // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 2ï¼šè¯­éŸ³åˆæˆ Promise å°è£…
    function speakWord(text) {
        return new Promise((resolve) => {
            // å…ˆåœæ­¢ä¹‹å‰çš„ï¼ˆé˜²æ­¢å †å ï¼‰
            synth.cancel();

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            
            // å°è¯•æŒ‡å®šä¸­æ–‡è¯­éŸ³ï¼ˆiOSå¿…é¡»ï¼‰
            if (chineseVoice) {
                u.voice = chineseVoice;
            }

            const selectedRate = document.getElementById('speechRate').value;
            u.rate = parseFloat(selectedRate);
            
            // ğŸ”¥ å…³é”®ï¼šå°† utterance èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼Œé˜²æ­¢ iOS åƒåœ¾å›æ”¶æœºåˆ¶è¿‡æ—©æ¸…ç†å®ƒå¯¼è‡´ onend ä¸è§¦å‘
            currentUtterance = u;

            u.onend = () => {
                currentUtterance = null; // é‡Šæ”¾
                resolve();
            };

            u.onerror = (e) => {
                console.error("Speech error", e);
                currentUtterance = null;
                // å³ä½¿å‡ºé”™ä¹Ÿ resolveï¼Œé˜²æ­¢å¡æ­»
                resolve();
            };

            synth.speak(u);

            // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 3ï¼šè¶…æ—¶å¼ºåˆ¶è·³è¿‡
            // å¦‚æœ 4 ç§’éƒ½æ²¡è¯»å®Œï¼ˆæˆ–è€… iOS æ²¡è§¦å‘ onendï¼‰ï¼Œå¼ºåˆ¶ç»§ç»­ï¼Œé˜²æ­¢å¡æ­»
            setTimeout(() => {
                if (currentUtterance === u) {
                    console.log("iOS timeout fallback triggered");
                    resolve();
                }
            }, 4000); 
        });
    }

    function updateProgress() {
        const total = currentSessionList.length;
        document.getElementById('progressText').innerText = `è¿›åº¦: ${currentIndex} / ${total}`;
        const pct = ((currentIndex) / total) * 100;
        document.getElementById('progressFill').style.width = `${pct}%`;
    }

    async function checkPause() {
        while (isPaused && isRunning) {
            await sleep(200);
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        if (isPaused) {
            synth.cancel(); 
            btn.innerText = 'ç»§ç»­';
            btn.style.background = "#dcfce7";
            btn.style.color = "#166534";
            document.getElementById('statusMsg').innerText = 'â¸ å·²æš‚åœ';
        } else {
            btn.innerText = 'æš‚åœ';
            btn.style.background = "#fffbeb";
            btn.style.color = "#b45309";
        }
    }

    function stopDictation() {
        if(confirm("ç¡®å®šè¦ç»“æŸå—ï¼Ÿ")) {
            isRunning = false;
            synth.cancel();
            document.getElementById('runningArea').style.display = 'none';
            document.getElementById('setupArea').style.display = 'block';
            updateMotivation("æ²¡å…³ç³»ï¼Œä¸‹æ¬¡ç»§ç»­ï¼");
        }
    }

    function finishDictation() {
        const display = document.getElementById('wordDisplay');
        display.innerHTML = '<div class="success-modal"><span class="star-icon">ğŸŒŸ</span><br>å®Œæˆ!</div>';
        display.style.fontSize = "2rem";
        document.getElementById('statusMsg').innerText = "å¤ªæ£’äº†ï¼å¿«æ£€æŸ¥ä¸€ä¸‹ï¼";
        
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').innerText = "100%";
        updateMotivation(quotes.end[Math.floor(Math.random()*quotes.end.length)]);

        const list = document.getElementById('answerList');
        let html = '<h3 style="margin-bottom:15px; color:#ea580c; text-align:center;">ğŸ† ç­”æ¡ˆæ ¸å¯¹å¡</h3><div class="answer-grid">';
        currentSessionList.forEach((w, i) => {
            html += `<div class="answer-item"><span style="font-size:0.7em;color:#aaa;display:block">${i+1}</span>${w}</div>`;
        });
        html += '</div><div style="text-align:center; margin-top:20px;"><button class="control-btn" onclick="location.reload()" style="background:#f97316;color:white;">å†æ¥ä¸€å±€</button></div>';
        
        list.innerHTML = html;
        list.style.display = 'block';
        document.querySelector('.control-btns').style.display = 'none';
        
        setTimeout(() => { list.scrollIntoView({ behavior: 'smooth' }); }, 500);
    }

    async function handlePdfUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const statusEl = document.getElementById('ocrStatus');
        statusEl.innerText = 'â³ æ­£åœ¨è§£æ...';
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            document.getElementById('customWordInput').value = fullText;
            statusEl.innerText = 'âœ… è§£ææˆåŠŸ';
        } catch (e) {
            console.error(e);
            statusEl.innerText = 'âŒ è§£æå¤±è´¥';
        }
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

</script>
</body>
</html>
